<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Recipes</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="styles.css">

    <!-- HEIC2Any Library -->
    <script src="https://cdn.jsdelivr.net/npm/heic2any@latest"></script>
</head>
<body>

    <nav class="text-center">
        <a href="index.html">Home</a>
        <a href="#">Recipes</a>
        <a href="descriptionPage.html">Description</a>
    </nav>

    <div class="container">
        <h1 class="my-4">All Recipes</h1>

        <!-- Recipe List (Dynamically Generated) -->
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="recipe-list">
            <!-- Recipes will be inserted here -->
        </div>

        <!-- Recipe Submission Form -->
        <div class="card mt-5 mx-auto" style="max-width: 500px;">
            <div class="card-body">
                <h2 class="card-title text-center">Submit a Recipe</h2>
                <form id="recipe-form">
                    <div class="mb-3">
                        <label for="recipe-name" class="form-label">Recipe Name:</label>
                        <input type="text" id="recipe-name" name="recipe-name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="recipe-description" class="form-label">Ingredients & Instructions:</label>
                        <textarea id="recipe-description" name="recipe-description" class="form-control" rows="5" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="recipe-images" class="form-label">Upload Images:</label>
                        <input type="file" id="recipe-images" name="recipe-images" class="form-control" multiple accept="image/*" required>
                    </div>
                    <button type="submit" class="btn btn-success w-100">Submit Recipe</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Load existing recipes
        async function loadRecipes() {
            try {
                const response = await fetch('recipes.json'); 
                const recipes = await response.json();
                const recipeList = document.getElementById('recipe-list');
    
                recipes.forEach(recipe => {
                    const recipeItem = document.createElement('div');
                    recipeItem.classList.add('col');
                    recipeItem.innerHTML = `
                        <div class="card">
                            <img src="${recipe.image}" class="card-img-top" alt="${recipe.name}">
                            <div class="card-body text-center">
                                <a href="${recipe.filename}" class="card-title">${recipe.name}</a>
                            </div>
                        </div>
                    `;
                    recipeList.appendChild(recipeItem);
                });
            } catch (error) {
                console.error("Error loading recipes:", error);
            }
        }
    
        loadRecipes();
    
        // Handle recipe submission
        document.getElementById("recipe-form").addEventListener("submit", async function(event) {
            event.preventDefault();
    
            const name = document.getElementById("recipe-name").value.trim();
            const description = document.getElementById("recipe-description").value.trim();
            const imageInput = document.getElementById("recipe-images");
            const images = [];
    
            // Convert images to base64
            if (imageInput.files.length > 0) {
                for (let file of imageInput.files) {
                    const fileExtension = file.name.split('.').pop().toLowerCase();
                    const reader = new FileReader();
                    const base64 = await new Promise((resolve) => {
                        reader.onload = () => resolve(reader.result);
                        reader.readAsDataURL(file);
                    });
    
                    // Handle HEIC or HEIF files
                    if (fileExtension === 'heic' || fileExtension === 'heif') {
                        try {
                            const convertedImage = await heic2any({ blob: file });
                            const convertedBase64 = await new Promise((resolve) => {
                                const imgBlob = new Blob([convertedImage], { type: 'image/jpeg' });
                                const reader = new FileReader();
                                reader.onloadend = () => resolve(reader.result);
                                reader.readAsDataURL(imgBlob);
                            });
                            images.push(convertedBase64);
                        } catch (err) {
                            console.error('Error converting HEIC/HEIF file:', err);
                        }
                    } else if (fileExtension === 'jpeg') {
                        // Convert .jpeg to .jpg
                        const convertedBase64 = base64.replace('data:image/jpeg', 'data:image/jpg');
                        images.push(convertedBase64);
                    } else {
                        // Add other accepted file types (e.g., png, jpg)
                        images.push(base64);
                    }
                }
            }
    
            try {
                const response = await fetch('https://birthday-gift-drab.vercel.app/api/submit-recipe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        description: description,
                        images: images
                    })
                });
    
                if (response.ok) {
                    alert("Recipe submitted successfully!");
                    document.getElementById("recipe-form").reset();
                } else {
                    const errorText = await response.text();
                    console.error("Server response:", errorText);
                    alert("Failed to submit recipe.");
                }
            } catch (error) {
                console.error("Error submitting recipe:", error);
                alert("There was an error submitting your recipe.");
            }
        });
    </script>

</body>
</html>
