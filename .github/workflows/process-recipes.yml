name: Process Recipe Submissions

on:
  issues:
    types: [opened]

jobs:
  process_recipe:
    if: contains(github.event.issue.labels.*.name, 'recipe-submission')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.x'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pillow pillow-heif

      - name: Extract Recipe Data and Convert Images
        run: |
          import json
          import os
          import re
          from PIL import Image
          import pillow_heif
          import requests

          issue_body = '''${{ github.event.issue.body }}'''

          # Extract data
          title = '${{ github.event.issue.title }}'.replace("New Recipe: ", "").strip()
          match = re.search(r'\*\*Ingredients & Instructions:\*\*\n(.*?)\n\n\*\*Images:\*\*', issue_body, re.DOTALL)
          instructions = match.group(1).strip() if match else "No instructions provided"
          image_links = re.findall(r'!\[.*?\]\((.*?)\)', issue_body)  # Extract image URLs

          os.makedirs("recipes", exist_ok=True)
          os.makedirs("images", exist_ok=True)

          local_images = []
          for url in image_links:
              img_name = url.split("/")[-1].split("?")[0]
              img_path = os.path.join("images", img_name)
              r = requests.get(url)
              with open(img_path, 'wb') as f:
                  f.write(r.content)

              if img_name.lower().endswith(('heic', 'heif')):
                  heif_file = pillow_heif.read_heif(img_path)
                  image = Image.frombytes(heif_file.mode, heif_file.size, heif_file.data, "raw")
                  jpg_name = os.path.splitext(img_name)[0] + '.jpg'
                  jpg_path = os.path.join("images", jpg_name)
                  image.save(jpg_path, 'JPEG')
                  os.remove(img_path)
                  local_images.append(jpg_path)
              else:
                  local_images.append(img_path)

          # Create recipe HTML file
          filename = f"{title.lower().replace(' ', '-')}.html"
          with open(f"recipes/{filename}", "w") as f:
              f.write(f"""
              <!DOCTYPE html>
              <html lang=\"en\">
              <head>
                  <meta charset=\"UTF-8\">
                  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">
                  <title>{title}</title>
                  <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css\" rel=\"stylesheet\">
              </head>
              <body class=\"container\">
                  <h1 class=\"my-4\">{title}</h1>
                  <p>{instructions.replace('\\n', '<br>')}</p>
                  <div>
                      {''.join(f'<img src="../{img}" class="img-fluid my-3" alt="{title}">' for img in local_images)}
                  </div>
              </body>
              </html>
              """)

          # Update recipes.json
          with open("recipes.json", "r+") as json_file:
              recipes = json.load(json_file)
              recipes.append({
                  "name": title,
                  "filename": f"recipes/{filename}",
                  "image": local_images[0] if local_images else "images/default.jpg"
              })
              json_file.seek(0)
              json.dump(recipes, json_file, indent=4)

        shell: python

      - name: Commit & Push Changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add recipes.json recipes/ images/
          git commit -m "Added new recipe: ${{ github.event.issue.title }}"
          git push

      - name: Create GitHub Issue
        run: |
          curl -X POST \
          -H "Authorization: token ${{ secrets.RECIPE_SUBMISSION_TOKEN }}" \
          -d '{"title": "New Recipe Submission", "body": "A new recipe has been submitted with details and images.", "labels": ["recipe-submission"]}' \
          https://api.github.com/repos/varnereh/BirthdayGift/issues
